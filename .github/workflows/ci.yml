name: CI/CD Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

env:
  PYTHON_VERSION: "3.12"
  NODE_VERSION: "20"
  POETRY_VERSION: "1.8.3"

jobs:
  # Security and dependency scanning
  security:
    name: Security Scanning
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  # Backend testing and validation
  backend-test:
    name: Backend Tests
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ["3.9", "3.10", "3.11", "3.12"]

    services:
      postgres:
        image: pgvector/pgvector:pg17
        env:
          POSTGRES_PASSWORD: testpassword
          POSTGRES_USER: testuser
          POSTGRES_DB: testdb
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: ${{ env.POETRY_VERSION }}
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: Load cached venv
        id: cached-poetry-dependencies
        uses: actions/cache@v4
        with:
          path: backend/.venv
          key: venv-${{ runner.os }}-${{ matrix.python-version }}-${{ hashFiles('**/poetry.lock') }}

      - name: Install dependencies
        if: steps.cached-poetry-dependencies.outputs.cache-hit != 'true'
        working-directory: ./backend
        run: poetry install --no-interaction --no-root

      - name: Install project
        working-directory: ./backend
        run: poetry install --no-interaction

      - name: Wait for PostgreSQL
        run: |
          until pg_isready -h localhost -p 5432 -U testuser; do
            echo "Waiting for PostgreSQL..."
            sleep 2
          done

      - name: Set up test environment
        working-directory: ./backend
        env:
          DATABASE_URL: postgresql://testuser:testpassword@localhost:5432/testdb
          REDIS_URL: redis://localhost:6379/0
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          DATA_DIRECTORY: /tmp/test_data
          ENVIRONMENT: testing
        run: |
          mkdir -p /tmp/test_data
          poetry run alembic upgrade head

      - name: Run linting
        working-directory: ./backend
        run: |
          poetry run ruff check .
          poetry run ruff format --check .

      - name: Run type checking
        working-directory: ./backend
        run: poetry run mypy src/

      - name: Run tests with coverage
        working-directory: ./backend
        env:
          DATABASE_URL: postgresql://testuser:testpassword@localhost:5432/testdb
          REDIS_URL: redis://localhost:6379/0
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          DATA_DIRECTORY: /tmp/test_data
          ENVIRONMENT: testing
        run: |
          poetry run pytest tests/ -v --cov=src --cov-report=xml --cov-report=html --cov-fail-under=75

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v4
        with:
          file: ./backend/coverage.xml
          flags: backend
          name: backend-coverage
          fail_ci_if_error: false

  # Frontend testing and validation
  frontend-test:
    name: Frontend Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Type checking
        run: |
          # Check if type-check script exists
          if bun run --silent type-check 2>/dev/null; then
            echo "Running type checking..."
            bun run type-check
          else
            echo "Type checking script not found, running tsc directly..."
            bunx tsc --noEmit
          fi

      - name: Linting
        run: |
          # Check if lint script exists
          if bun run --silent lint 2>/dev/null; then
            echo "Running linting..."
            bun run lint
          else
            echo "Linting script not found, skipping..."
          fi

      - name: Build application
        env:
          NEXT_PUBLIC_API_URL: http://localhost:8000/api
        run: bun run build

      - name: Run tests (when available)
        run: |
          # Add test command when frontend tests are implemented
          echo "Frontend tests will be added in future iterations"

  # Integration testing
  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [backend-test, frontend-test]

    services:
      postgres:
        image: pgvector/pgvector:pg17
        env:
          POSTGRES_PASSWORD: testpassword
          POSTGRES_USER: testuser
          POSTGRES_DB: testdb
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7-alpine
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: ${{ env.POETRY_VERSION }}
          virtualenvs-create: true
          virtualenvs-in-project: true

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install backend dependencies
        working-directory: ./backend
        run: poetry install --no-interaction

      - name: Install frontend dependencies
        run: bun install

      - name: Wait for services
        run: |
          until pg_isready -h localhost -p 5432 -U testuser; do
            echo "Waiting for PostgreSQL..."
            sleep 2
          done

      - name: Set up test database
        working-directory: ./backend
        env:
          DATABASE_URL: postgresql://testuser:testpassword@localhost:5432/testdb
          REDIS_URL: redis://localhost:6379/0
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          DATA_DIRECTORY: /tmp/test_data
          ENVIRONMENT: testing
        run: |
          mkdir -p /tmp/test_data
          poetry run alembic upgrade head

      - name: Start backend server
        working-directory: ./backend
        env:
          DATABASE_URL: postgresql://testuser:testpassword@localhost:5432/testdb
          REDIS_URL: redis://localhost:6379/0
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          DATA_DIRECTORY: /tmp/test_data
          ENVIRONMENT: testing
        run: |
          poetry run uvicorn src.jd_ingestion.main:app --host 0.0.0.0 --port 8000 &
          sleep 10

      - name: Build and start frontend
        env:
          NEXT_PUBLIC_API_URL: http://localhost:8000/api
        run: |
          bun run build
          bun run start &
          sleep 10

      - name: Run integration tests
        working-directory: ./backend
        env:
          DATABASE_URL: postgresql://testuser:testpassword@localhost:5432/testdb
          REDIS_URL: redis://localhost:6379/0
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          DATA_DIRECTORY: /tmp/test_data
          ENVIRONMENT: testing
          FRONTEND_URL: http://localhost:3000
          BACKEND_URL: http://localhost:8000
        run: |
          poetry run pytest tests/integration/ -v --tb=short

  # Build and release preparation
  build:
    name: Build and Release Preparation
    runs-on: ubuntu-latest
    needs: [security, integration-test]
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install Poetry
        uses: snok/install-poetry@v1
        with:
          version: ${{ env.POETRY_VERSION }}

      - name: Build backend distribution
        working-directory: ./backend
        run: |
          poetry install --no-interaction
          poetry build

      - name: Build frontend for production
        env:
          NEXT_PUBLIC_API_URL: https://api.jddb.example.com/api
        run: |
          bun install
          bun run build

      - name: Create deployment artifacts
        run: |
          mkdir -p dist/
          cp -r backend/dist/ dist/backend/
          cp -r .next/ dist/frontend/
          cp -r public/ dist/frontend/public/
          tar -czf jddb-release-${{ github.sha }}.tar.gz dist/

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: jddb-release-${{ github.sha }}
          path: jddb-release-${{ github.sha }}.tar.gz
          retention-days: 30

  # Deployment (placeholder for future implementation)
  deploy:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: [build]
    if: github.ref == 'refs/heads/main'
    environment: staging

    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: jddb-release-${{ github.sha }}

      - name: Deploy to staging
        run: |
          echo "Deployment step will be implemented based on target infrastructure"
          echo "Artifact: jddb-release-${{ github.sha }}.tar.gz"
          # Add deployment commands for your target environment here